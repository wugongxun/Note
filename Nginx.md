# 第一章 Nginx简介

## 一，Nginx概述

Nginx(”engine x")是一个高性能的HTTP和反向代理服务器，特点是占有内存少，并发能力强，事实上Nginx的并发能力确实在同类型的网页服务器中表现较好，Nginx专为性能优化而开发，性能是其最重要的考量，实现上非常注重效率，能经受高负载的考验，有报告表明能支持高达50,000个并发连接数。

## 二，Nginx相关概念

1. 反向代理

   - 正向代理：如果把局域网外的Internet想象成一个巨大的资源库，则局域网中的客户端要访问Internet,则需要通过代理服务器来访问，这种代理服务就称为正向代理。
   - 反向代理：其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器P地址。

2. 负载均衡

   客户端发送多个请求到服务器，服务器处理请求，有一些可能要与数据库进行交互，服务器处理完毕后，再将结果返回给客户端。这种架构模式对于早期的系统相对单一，并发请求相对较少的情况下是比较适合的，成本也低。但是随着信息数量的不断增长，访间量和数据量的飞速增长，以及系统业务的复杂度增加，这种架构会造成服务器相应客户端的请求日益缓慢，并发量特别大的时候，还容易造成服务器直接崩溃。很明显这是由于服务器性能的瓶颈造成的问题，那么如何解决这种情况呢？

   我们首先想到的可能是升级服务器的配置，比如提高CPU执行频率，加大内存等提高机器的物理性能来解决此问题，但是我们知道摩尔定律的日益失效，硬件的性能提升已经不能满足日益提升的需求了。最明显的一个例子，天猫双十一当天，某个热销商品的瞬时访问量是极其庞大的，那么类似上面的系统架构，将机器都增加到现有的项级物理配置，都是不能够满足需求的。那么怎么办呢？上面的分析我们去掉了增加服务器物理配置来解决问题的办法，也就是说纵向解决问题的办法行不通了，那么横向增加服务器的数量呢？这时候集群的概念产生了，**单个服务器解决不了，我们增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是我们所说的负载均衡**

3. 动静分离

   为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。 

# 第二章 配置实例

## 一，安装

1. 安装pcre依赖

   - 下载pcre：wget https://netix.dl.sourceforge.net/project/pcre/pcre/8.40/pcre-8.40.tar.gz
   - ./configure
   - make && make install
   - 查看版本号：pcre-config --version

2. 安装其他依赖

   yum install make zlib zlib-devel gcc-c++ libtool openssl openssl-devel

3. 安装Nginx

   - 解压
   - ./configure
   - make && make install

4. 安装完成之后启动脚本在/usr/local/nginx/sbin下

## 二，Nginx常用命令

1. 查看版本号

   ./nginx -v

2. 启动Nginx

   ./nginx

3. 停止Nginx

   ./nginx -s stop

4. 重加载

   ./nginx -s reload

## 三，Nginx配置文件

1. 全局块

   从配置文件开始到events块之间的内容，主要会设置一些影响nginx服务器整体运行的配置指令，主要包括配置运行nginx服务器的冉户（组）、允许生成的worker_process数，进程PID存放路径、日志存放路径和类型以及配置文件的引入等。

   - worker_processes  1;

     worker_processes越大，可以支持的并发处理越多

2. events块

   events块涉及的指令主要影响Nginx服务器与用户的网路连接

   - worker_connections  1024;

     支持的最大连接数

3. http块

   - http全局块

     http全局块配置的指今包括文件引入、MIME-TYPE定义、日志自定义、连接超时时间、单链接请求数上限等。

   - server块

     这块和虚拟主机有密切关系，虚拟主机从用户角度看，和一台独立的硬件主机是完全一样的，该技术的产生是为了节省互联网服务器硬件成本。

     - 全局server块

       最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或IP配置。

     - location块

       这块的主要作用是基于nginx服务器接收到的请求字符串（例如server_name/uri-string)，对虚拟主机名称(也可以是IP别名)之外的字符串（例如前面的/uri-stig）进行匹配，对特定的请求进行处理。重定向、数据缓存和应答控制等功能，还有许多第三方模块的配置他在这里进行。

## 四，反向代理

1. 修改配置文件

   ```conf
   server {
       listen       80;
       server_name  localhost;
   
       #charset koi8-r;
   
       #access_log  logs/host.access.log  main;
   
       location / {
           root   html;
           proxy_pass  http://localhost:8080;
           index  index.html index.htm;
       }
   ```

2. 实现访问http://127.0.0.1:9001/edu/跳转到127.0.0.1:8080，访问http://127.0.0.1:9001/vod/跳转到127.0.0.1:8081

   ![](F:\截图\屏幕截图 2022-05-02 213056.png)

3. location指令说明

   - =：用于不含正则表达式的uri前，要求请求字符串与uri严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。
   - ~：用于表示uri包含正则表达式，并且区分大小写。
   - ~\*：用于表示uri包含正则表达式，并且不区分大小写。
   - ^~：用于不含正则表达式的uri前，要求nginx服务器找到标识uri和请求字符串匹配度最高的location后，立即使用此location处理请求，而不再使用location块中的正则uri和请求字符串做匹配。
   - 注意：如果uri包含正则表达式，则必须要有~或者*标识。

## 五，负载均衡

1. ![](F:\截图\屏幕截图 2022-05-03 143056.png)

2. ![](F:\截图\屏幕截图 2022-05-03 143212.png)

3. 随着互联网信息的爆炸性增长，负载均衡(load balance)已经不再是一个很陌生的话题，顾名思义，负载均衡即是将负载分摊到不同的服务单元，既保证服务的可用性，又保证响应足够快，给用户很好的体验，快速增长的访问量和数据流量催生了各式各样的负载均衡产品，很多专业的负载均衡硬件提供了很好的功能，但却价格不菲，这使得负载均衡软件大受欢迎，nginx就是其中的一个，在Linux下有Nginx、LVS、Haproxy等等服务可以提供负载均衡服务，而且Nginx提供了几种分配方式（策路）。

   - 轮询（默认）

     每个请求按时间顺序逐一分到不同的后端服务器，如果后端服务器down掉，能自动剔除。

   - weight

     weight代表权，重默认为1，权重越高被分配的客户端越多，指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。

   - ip_hash

     每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。

   - fair

     按后端服务器的响应时间来分配请求，响应时间短的优先分配。

## 六，动静分离

nginx动静分离简单来说就是把动态跟静态请求分开，不能理解成只是单纯的把动态页面和静态页面物理分离。严格意义上说应该是动态请求跟静态请求分开，可以理解成使用nginx处理静态页面，Tomcat处理动态页面。动静分离从目前实现角度来讲大致分为两种，一种是纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案。另外一种方法就是动态跟静态文件混合在一起发布，通过nginx来分开。通过location指定不同的后缀名实现不同的请求转发。通过expires参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量。具体Expires定义：是给一个资源设定一个过期时间，也就是说无需去服务端验证，直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源。（如果经常更新的文件，不建议使用Expires来缓存)，我这里设置3d，表示在这3天之内访问这个URL，发送一个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码304,如果有修改，则直接从服务器重新下载，返回状态码200。

![](F:\截图\屏幕截图 2022-05-03 151908.png)

## 七，高可用

1. 安装keepalived

   yum install keepalived

2. 修改/etc/keepalived/keepalived.conf

3. 绑定检测脚本

   
